#!/bin/sh
#
# Start swupdate daemon for single partition OTA updates
#

DAEMON="swupdate"
PIDFILE="/var/run/$DAEMON.pid"
SWUPDATE_WRAPPER="/usr/lib/swupdate/swupdate.sh"

start() {
    echo -n "Starting $DAEMON: "

    # Create required directories
    mkdir -p /tmp/swupdate
    mkdir -p /var/run

    # Use the swupdate wrapper script which handles conf.d configuration
    start-stop-daemon -S -q -p $PIDFILE -x $SWUPDATE_WRAPPER
    [ $? = 0 ] && echo "OK" || echo "FAIL"
}

stop() {
    echo -n "Stopping $DAEMON: "
    start-stop-daemon -K -q -p $PIDFILE
    [ $? = 0 ] && echo "OK" || echo "FAIL"
}

case "$1" in
  start)
    start
    ;;
  stop)
    stop
    ;;
  restart|reload)
    stop
    sleep 1
    start
    ;;
  status)
    if [ -f "$PIDFILE" ] && kill -0 "$(cat "$PIDFILE")" 2>/dev/null; then
        echo "$DAEMON is running (PID $(cat "$PIDFILE"))"
        return 0
    else
        echo "$DAEMON is not running"
        return 1
    fi
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|reload|status}"
    exit 1
esac

exit $?